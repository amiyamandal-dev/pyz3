name: Publish pyz3

on:
  push:
    tags: ["v*"]

permissions:
  id-token: write
  contents: write

env:
  PYTHON_VERSION: "3.13"

jobs:
  publish:
    environment:
      name: pypi
      url: https://pypi.org/p/pyz3
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Build package
        run: uv build

      - name: Install docs dependencies
        run: uv sync --group docs

      - name: Build Zig docs
        run: uv run python -m ziglang build docs

      - name: Setup git for docs
        run: |
          git config --global user.name "Docs Deploy"
          git config --global user.email "docs@dummy.bot.com"

      - name: Get version
        id: get_version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major_minor=$MAJOR.$MINOR" >> $GITHUB_OUTPUT

      - name: Deploy docs
        run: uv run mike deploy ${{ steps.get_version.outputs.major_minor }} latest --push --update-aliases

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
